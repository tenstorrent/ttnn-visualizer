name: Build and Upload Python Wheel on Release

on:
    release:
        types: [created]  # Triggers when a release is created

env:
    CIBW_BUILD_VERBOSITY: 1
    VITE_API_ROOT: api
    NPM_CONFIG_PRODUCTION: false

jobs:
    build:
        name: Build Python Wheel
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Use Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: v22.1.0
            - run: npm install
            - run: npm run build

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.12.3'

            - name: Install build dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build

            - name: Build wheel
              run: |
                  python -m build --wheel

            - name: Upload wheel as artifact
              uses: actions/upload-artifact@v3
              with:
                  name: python-wheel
                  path: dist/*.whl

    release:
        name: Upload Wheel to GitHub Release
        runs-on: ubuntu-latest
        needs: build  # Depends on the build job

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Download wheel artifact
              uses: actions/download-artifact@v3
              with:
                  name: python-wheel

            - name: Upload Wheel to Release
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ github.event.release.upload_url }}
                  asset_path: dist/*.whl
                  asset_name: ttnn-visualizer-${{ github.event.release.tag_name }}.whl
                  asset_content_type: application/octet-stream
